// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Trade {
  id             String    @id @default(cuid())
  type           String    // 'put-credit-spread' | 'long-call'
  symbol         String
  expirationDate DateTime
  quantity       Int

  // Put Credit Spread fields
  shortStrike    Float?
  longStrike     Float?
  creditReceived Float?

  // Long Call fields
  callStrike     Float?
  premiumPaid    Float?

  // Trade management
  status         String    @default("potential") // 'potential' | 'active' | 'closed' | 'expired'
  entryDate      DateTime  @default(now())
  exitDate       DateTime?
  exitPrice      Float?
  finalProfitLoss Float?

  // IPS tracking (UPDATED)
  ipsScore       Int       @default(0)
  ipsName        String?   // Name of IPS used for this trade
  ipsNotes       String    @default("")

  // Analysis
  notes          String?
  lessons        String?

  // Relations
  snapshots      TradeSnapshot[]

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@map("trades")
}

model IPSCriteria {
  id                   String   @id @default(cuid())
  name                 String   @default("My IPS") // Allow multiple IPS versions
  
  // PCS Setup Criteria
  minIV                Float    // Minimum IV percentage (e.g., 40)
  minIVRank            Int?     // Minimum IV Rank (e.g., 50)
  maxBidAskSpread      Float    // Maximum bid-ask spread (e.g., 0.10)
  minDeltaShortLeg     Float    // Minimum delta for short leg (e.g., 0.10)
  maxDeltaShortLeg     Float    // Maximum delta for short leg (e.g., 0.25)
  minPremiumPercent    Float    // Min premium as % of collateral (e.g., 20)
  targetROI            Float    // Target ROI percentage (e.g., 6)
  
  // DTE Preferences
  preferredDTE         String   @default("both") // "7dte", "14dte", or "both"
  minDTE               Int      // Minimum days to expiration
  maxDTE               Int      // Maximum days to expiration
  
  // Volume & Liquidity
  minStockVolume       Int      // Min daily stock volume (e.g., 1000000)
  minOptionsVolume     Int      // Min options volume (e.g., 10000)
  minOpenInterest      Int      // Min open interest (e.g., 500)
  
  // Stock Selection
  preferredSectors     String   @default("[]") // JSON array of preferred sectors
  avoidedSectors       String   @default("[]") // JSON array of avoided sectors
  avoidCorrelatedTickers Boolean @default(true) // Avoid stacking correlated positions
  
  // News & Earnings
  avoidEarnings        Boolean  @default(true) // Avoid holding through earnings
  earningsBuffer       Int      @default(0)    // Days buffer around earnings
  
  // Exit & Risk Management
  targetProfitPercent  Float    @default(75)   // Close at X% of max gain
  maxLossPercent       Float    @default(100)  // Max loss before exit
  maxOpenPositions     Int      @default(3)    // Max simultaneous positions
  maxCollateralPerTrade Float   @default(300)  // Max collateral per trade
  positionSizeLimit    Int      @default(2)    // Max contracts per setup
  
  // Rolling Rules
  rollEarlyDTE         Int      @default(3)    // When to consider rolling (3-4 DTE)
  rollOnDeltaIncrease  Boolean  @default(true) // Roll if delta increases significantly
  
  // Strategy Specific
  allowHybridStrategy  Boolean  @default(false) // PCS + Long Calls hybrid
  maxEarningsExposure  Float    @default(50)   // Max % of portfolio in earnings plays
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  isActive             Boolean  @default(true)  // Allow multiple IPS, mark active one

  @@map("ips_criteria")
}

model WatchlistStock {
  id           String   @id @default(cuid())
  symbol       String   @unique
  companyName  String
  sector       String?
  currentPrice Float?
  previousClose Float?   // Track price changes
  priceChange  Float?    // $ change from previous close
  priceChangePercent Float? // % change
  volume       Int?      // Current volume
  avgVolume    Int?      // Average volume
  marketCap    Float?    // Market capitalization
  notes        String?
  addedDate    DateTime @default(now())
  lastUpdated  DateTime @default(now()) // Track when price was last updated
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("watchlist_stocks")
}

model JournalEntry {
  id        String   @id @default(cuid())
  title     String
  content   String
  weekOf    DateTime // Monday of the week this entry is for
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("journal_entries")
}

// NEW: Trade snapshots for market open, midday, close
model TradeSnapshot {
  id          String   @id @default(cuid())
  tradeId     String   // Foreign key to Trade
  ipsName     String?  // Which IPS this snapshot is under
  timestamp   DateTime
  snapshotType String  // 'market_open' | 'midday' | 'market_close'
  
  // Current market data at snapshot time
  currentPrice    Float
  premium         Float
  delta           Float?
  theta           Float?
  gamma           Float?
  vega            Float?
  rho             Float?
  impliedVol      Float?
  
  // P&L at this moment
  unrealizedPL    Float
  unrealizedPLPercent Float
  
  // Position Greeks summary
  positionDelta   Float?
  positionTheta   Float?
  
  trade Trade @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@map("trade_snapshots")
  @@index([tradeId])
  @@index([timestamp])
}

// NEW: API sync tracking
model APISync {
  id           String   @id @default(cuid())
  dataType     String   // 'trades' | 'market_data' | 'watchlist'
  lastSyncAt   DateTime
  syncStatus   String   // 'success' | 'error' | 'in_progress'
  errorMessage String?
  recordsProcessed Int @default(0)
  
  createdAt    DateTime @default(now())
  
  @@map("api_syncs")
}

// NEW: Archive tracking for yearly exports
model ArchiveLog {
  id        String   @id @default(cuid())
  year      Int
  dataType  String   // 'trade_snapshots' | 'watchlist_history'
  filePath  String   // Where the data was exported
  recordCount Int    // How many records were archived
  fileSize  Int?     // Size in bytes
  createdAt DateTime @default(now())
  
  @@map("archive_logs")
  @@index([year, dataType])
}